<?php
require ("includes/connection.php");
require_once ("includes/form_functions.php");

$form_fields= array('username', 'password');
foreach($form_fields as $fieldname) {
	$form_data[$fieldname]='';
}

if(isset($_POST['submit'])){
	
	/*--validare formular--*/ 
	
	//init errors; pentru un camp va fi semnalata o singura eroare
	$errors = init_errors($form_fields);
		
	//campuri obligatorii
	$required_fields = array('username','password');
	$required_fields_errors=check_required_fields($required_fields);
	
	/*	
	//campuri cu format
	$fields_with_pattern=array('name'=>'/^[a-zA-Z\-\s\']{2,20}$/', 'username'=>'/^[a-zA-Z\-0-9]{4,15}$/', 'password'=>'/^[A-Za-z]\w{6,}[A-Za-z]$/','email'=>'/^[a-zA-Z0-9\.\-_\+]+@[a-zA-Z0-9\-]+\.([a-zA-Z0-9\-]+\.)*[a-zA-Z]{2,3}$/');
	$fields_with_pattern_errors=check_fields_with_pattern($fields_with_pattern);
	*/
	$errors=$required_fields_errors;//+$fields_with_pattern_errors;//reuniune de array-uri; pt valori cu aceeasi cheie, se pastreaza valaorea din primul array
	
	/*--procesarea datelor sau afisare erorilor--*/
	//print_r($errors);
	if(!empty($errors)){//daca am erori, le afisez
	display_error($errors);
	}else{//daca nu am erori, procesez datele
		$username=mysqli_real_escape_string($connection,$_POST['username']);
		$password=$_POST['password'];
		$hashed_password = md5($password);//in bd am parola criptata; pentru securitate, se mai poate atasa parolei un string si apoi se aplica alg de criptare
		
		//extrag din baza de date datele userului
		$query="SELECT id,name,email 
					FROM users 
					WHERE username='{$username}' AND password='{$hashed_password}'
					LIMIT 1";
	
		$result=mysqli_query($connection,$query) or die(msqli_error($connection));
		$d=mysqli_fetch_array($result);
		//print_r($d);
		
		//memorez intr-o sesiune datele user-ului
		session_start();
		$_SESSION['user_id']=$d['id'];
		//$_SESSION['name']=$d['name'];
		//$_SESSION['email']=$d['email'];
	//	$_SESSION['loggedin']=time();
		
		//print_r($_SESSION);
		
		 header('Location:welcome.php');
		
	}//end "nu am erori"
mysqli_close($connection);//inchid conexiunea cu baza de date	
}//end "am apasat butonul submit"
?>

<html>
<head>
	<meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />
	<title></title>
</head>
<body>
<br /><br />
<form action="login.php" method="post">
			<table>
				<tr>
					<td>Username:</td>
					<td><input type="text" name="username" maxlength="30" value="<?php echo htmlentities($form_data['username']); ?>" /></td>
				</tr>
				<tr>
					<td>Password:</td>
					<td><input type="password" name="password" maxlength="30" value="<?php echo htmlentities($form_data['password']); ?>" /></td>
				</tr>
				<tr>
					<td colspan="2"><input type="submit" name="submit" value="Submit" /></td>
				</tr>
			</table>
</form>

</body>
</html>